https://github.com/benranco


SNPpipeline

LepMAP2: 
  x- LepMAP2pipeline.sh, 
  x- tabulate_OrderMarkers_results.R / remove_duplicate_markers-VERSION2.R, 
  x- convert_csv_to_linkage.R, convert_csv_to_linkage_alreadyHorizontal.R?)

xLPmerge (LPmergeScript.R, ???) 

xCircos

createStripChartFromLGs.R, mybeanplot.R, createStripChartFromLGs-beeswarm.R

FilterForIsabel pipeline (on her machine):
  - filterForIsabel.sh
  - filterForIsabel_part1.R
  - getDepthStats-parallel.R
  - filterForIsabel_part3.R
  - filterForIsabel_part4.R

- what is ncdf/netcdf used for again? - I think it was for David Dunn.
----------------------
Small scripts:

removeRows.R
scratch10, scratch10_2
extractRowsFromCsvForJunJun.R
combineCsvTablesByColumn.R
getDepthStats-parallel.R
filter46sampleData.R (for Jun-Jun)
filterForHolly.R
MyCountClustScript.R, MyHeatmapScript.R

----------------------
Helpful:

LepMAP2:
LepMAP2-testInfo.txt, LepMAP2-testOutput.txt, LepMAP2-usageInfo.txt, 

summaryOfTasks.txt 
VCFdata-troubleshooting.txt
exampleData.txt
temp.txt

Documentation in git docs folder:
- RScriptsSummary.txt, SNPpipeline-overview, SNPpipeline-process.txt, samtools-Help.txt, freebayes-Help.txt, bowtie2-Help.txt




==============
Snippet of some possible scenarios for LepMAP2pipeline documentation:
- skip the Filtering module because you've determined Filtering isn't needed
- skip Filtering, SeparateChromosomes and JoinSingles because you've already run them and you just want to rerun OrderMarkers to see if you get better results (the OrderMarkers results are slightly different each time)
- skip Filtering, SeparateChromosomes and JoinSingles because you've finished a complete run of the LepMAP2 pipeline, including the OrderMarkers module, and you've run the tabulate_OrderMarkers_results.R script on the output, and you now want to do a second pass of the OrderMarkers module on the output of the first pass. In this case you should also make sure you use the new map file generated by tabulate_OrderMarkers_results.R in addition to the new .csv data file.

- put parameter_name: in comments


==============




# REMEMBER TO UNCOMMENT THE SAMTOOLS CALL IN GETDEPTHSTATS !!!!!!!!!!!!!!!!!!!!!




OLD CONTINUE HERE: 
- convert .csv data to fasta, read firefox tab:
  https://stat.ethz.ch/pipermail/r-help/2011-August/288579.html
- convert these fasta files to fastq
- run through realphy and csi phylogeny
- read up on firefox tabs:
  http://www.mybiosoftware.com/phylosnp-take-snp-data-files-csv-and-vcf-and-generate-phylogenetic-trees.html
  https://www.ncbi.nlm.nih.gov/pubmed/24930720

- use the phylogenetic tool "mega" to analyse the new generated fasta file. (also try RealPhy and CSI Phylogeny). With a small sample fasta file first.




Files to commit to Git:
- updates to the files in Documents/stripChartMods
- MyCountClustScript.R, MyThetaMatrixScript.R, MyTemppUpdateThetaMatrixScript.R,MyHeatmapScript.R
- scripts on Isabel's computer

=======================================



x- check on progress of SNPpipeline run of Jun-Jun's 46 sample dataset (new report gen)
x- check-in code to fix check.names bug, and make sure code in SNPpipelineDevel and SNPpipelineDevel-fluidigm is up-to-date
x- test and check-in latest code to: choose which half of the pipeline to run, which optional reports to generate, to run the new depth stats report, and the new required folder for depth files.
- separate large ref file into chunks, and run SNPpipeline on a chunk (jun-jun's new SNP piplines for his 46-sample data set, using his two larger reference files rather than the 14706 ref)
- continue updating code in SNPpipelineDevel-fluidigm 


---
Old ideas for raw data file name bug fix (already fixed):

if [[ "H5Positive_Control_2_R1.fastq.gz" == *".fastq.gz" ]]; then echo "yeah"; fi 
 
or ???:
for i in *R1.hello ; do mv "$i" "${i/-[0-9.]*.pkg/.pkg}" ; done

or (I used this one):
for file in *R1.fastq ; do mv $file $(echo $file | rev | cut -c 9- | rev)---R1.fastq; done
for file in *R2.fastq ; do mv $file $(echo $file | rev | cut -c 9- | rev)---R2.fastq; done

...and then rename them back at the end
---


Overall Todo:
x- update and rerun depth stats (investigate empty cells)
x- check on changes not staged for commit, see if there's anything wrong there
x- transfer to isabel's computer
~ follow up with Holly about desktop icon
- update SNPpipeline to:
    x- capture bowtie console alignment summary output. Also write a script to go back and rerun bowtie for each sample and save the summary.
    x- fix the bug on line 96 and 117 of start.sh (cut -c 13- assumes fastq.gz) (see above for ideas)
    x- integrate depth stats script 
    x- check-in to git the new subdirectory dataTemp/depthfiles required for depth stats script
    x- enable you to choose which reports to run
    x- run only pre-reports, or run only reports
    - fix row names = true for mutation report
    ~ investigate why SNPpipeline is only doing A/A for some (maybe NA originally?) cells, and just A/ for others. (seems to be related to whether input to freebayes is haploid or diploid)
    ~ find out how the vcf_to_tab is choosing whether to display the ALT or the REF. Does it just take the larger
  of RO and AO, or has that already been decided by freebayes when it created the .vcf, if the -p (default
  ploidy) is (1) haploid (Jun-Jun) as opposed to (2) diploid (Isabel).
    ~ investigate, can parallel_process.R be sped up by traversing down each col first rather than across?
    ~ introduce R parallelism where possible (see getDepthStats-parallel.R as an example)
    ~ write a script to load all required R libraries before beginning (to run both in standalone as sudo and in the pipeline)
x- run SNPpipeline on Jun-Jun's new data
x- update all my scripts that use read.table or read.csv to specify check.names=FALSE (to prevent from converting dashes into periods), and make sure the code doesn't use col names as variables (see report_subset.R in latest SNPpipeline code).
~ organize scripts into folders, with example input/ouput data files
- install second hard drive
- finish thoroughly documenting stuff
- ?(emailed myself on Dec 6:) Fix rownames=TRUE for mutation report

Todo:
x- using MAF_cutoff_report, for each sample (col) go back to the sam or bam file, and find out, for each position (row/cell), how many of the most ocurring [A,T,C,G] for jun-jun's, and top two occuring for isabel.

- Q: why does the .sam file not have an entry for LPss160665_c2_seq1_m.97765 with position 122 while the samtools depth output and the VCF (even the _cutoff) file both do?


x- create .csv file that replaces each data cell with DP, and another that replaces them with DP;DPB;RO;AO
x- check to see if NA cells have data in the .sam and/or the unfiltered vcf files (if it's the same as the ref, there should be data, otherwise it'll be 0) 


To parallelize getDepthStats:
- subset it into one .Rds per column, saved to a folder
- for each .Rds, do what's in getDepthStats.R, save it to a new .Rds in another folder
- read in all the .Rds's and combine them into one table


=========================
.sam: raw data after being aligned
.bam: compressed version of .sam
_sorted.bam: as name suggests
_sorted.bam.bai: index for sorted .bam
.vcf: after finding SNPs with freebayes
.recode.vcf: after removing indels
_cutoff: after filtering out all data whose QUAL field is less than 5 (still in vcf format)
.tab: after converting the _cutoff file to a tab-delimited text file listing the actual variants instead of ALT indexes.


=========================
Row extracted from Jun-Jun's VCF _cutoff file for:
cat MI.M03992_0050.001.FLD0289.Fluidigm_301_cutoff | grep "LPss160665"

This row corresponds to the first row in the MAF_cutoff.csv file:
LPss160665_c2_seq1_m.97765	122	.	G	A	2224.35	PASS	AB=0;ABP=0;AC=1;AF=1;AN=1;AO=127;CIGAR=1X;DP=165;DPB=165;DPRA=0;EPP=3.0274;EPPR=3.0103;GTI=0;LEN=1;MEANALT=1;MQM=35.7795;MQMR=35.5789;NS=1;NUMALT=1;ODDS=512.177;PAIRED=1;PAIREDR=1;PAO=0;PQA=0;PQR=0;PRO=0;QA=4263;QR=1176;RO=38;RPL=0;RPP=278.787;RPPR=85.5263;RPR=127;RUN=1;SAF=64;SAP=3.0274;SAR=63;SRF=19;SRP=3.0103;SRR=19;TYPE=snp	GT:DP:DPR:RO:QR:AO:QA:GL	1:165:165,127:38:1176:127:4263:-249.751,0

The same row broken into chunks:
LPss160665_c2_seq1_m.97765	
122	
.	
G	
A	
2224.35	
PASS	
AB=0;ABP=0;AC=1;AF=1;AN=1;AO=127;CIGAR=1X;DP=165;DPB=165;DPRA=0;EPP=3.0274;EPPR=3.0103;GTI=0;LEN=1;MEANALT=1;MQM=35.7795;MQMR=35.5789;NS=1;NUMALT=1;ODDS=512.177;PAIRED=1;PAIREDR=1;PAO=0;PQA=0;PQR=0;PRO=0;QA=4263;QR=1176;RO=38;RPL=0;RPP=278.787;RPPR=85.5263;RPR=127;RUN=1;SAF=64;SAP=3.0274;SAR=63;SRF=19;SRP=3.0103;SRR=19;TYPE=snp	
GT:DP:DPR:RO:QR:AO:QA:GL	
1:165:165,127:38:1176:127:4263:-249.751,0


AB=0;ABP=0;AC=1;AF=1;AN=1;AO=127;
CIGAR=1X;
DP=165;DPB=165;DPRA=0;
EPP=3.0274;EPPR=3.0103;GTI=0;
LEN=1;
MEANALT=1;MQM=35.7795;MQMR=35.5789;
NS=1;NUMALT=1;
ODDS=512.177;
PAIRED=1;PAIREDR=1;PAO=0;PQA=0;PQR=0;PRO=0;
QA=4263;QR=1176;
RO=38;RPL=0;RPP=278.787;RPPR=85.5263;RPR=127;RUN=1;
SAF=64;SAP=3.0274;SAR=63;SRF=19;SRP=3.0103;SRR=19;
TYPE=snp	


NS		1= "Number of samples with data"
***DP		165= "Total read depth at the locus"
***DPB		165= "Total read depth per bp at the locus; bases in reads overlapping / bases in haplotype"
***AC		1= "Total number of alternate alleles in called genotypes"
***AN		1= "Total number of alleles in called genotypes"
AF		1= "Estimated allele frequency in the range (0,1]"
***RO		38= "Reference allele observation count, with partial observations recorded fractionally"
***AO		127= "Alternate allele observations, with partial observations recorded fractionally"
PRO		0= "Reference allele observation count, with partial observations recorded fractionally"
PAO		0= "Alternate allele observations, with partial observations recorded fractionally"
QR		1176= "Reference allele quality sum in phred"
QA		4263= "Alternate allele quality sum in phred"
PQR		0= "Reference allele quality sum in phred for partial observations"
PQA		0= "Alternate allele quality sum in phred for partial observations"
SRF		19= "Number of reference observations on the forward strand"
SRR		19= "Number of reference observations on the reverse strand"
SAF		64= "Number of alternate observations on the forward strand"
SAR		63= "Number of alternate observations on the reverse strand"
SRP		3.0103= "Strand balance probability for the reference allele: Phred-scaled upper-bounds estimate of the probability of observing the deviation between SRF and SRR given E(SRF/SRR) ~ 0.5, derived using Hoeffding's inequality"
SAP		3.0274= "Strand balance probability for the alternate allele: Phred-scaled upper-bounds estimate of the probability of observing the deviation between SAF and SAR given E(SAF/SAR) ~ 0.5, derived using Hoeffding's inequality"
AB		0= "Allele balance at heterozygous sites: a number between 0 and 1 representing the ratio of reads showing the reference allele to all reads, considering only reads from individuals called as heterozygous"
ABP		0= "Allele balance probability at heterozygous sites: Phred-scaled upper-bounds estimate of the probability of observing the deviation between ABR and ABA given E(ABR/ABA) ~ 0.5, derived using Hoeffding's inequality"
RUN		1= "Run length: the number of consecutive repeats of the alternate allele in the reference genome"
RPP		278.787= "Read Placement Probability: Phred-scaled upper-bounds estimate of the probability of observing the deviation between RPL and RPR given E(RPL/RPR) ~ 0.5, derived using Hoeffding's inequality"
RPPR		85.5263= "Read Placement Probability for reference observations: Phred-scaled upper-bounds estimate of the probability of observing the deviation between RPL and RPR given E(RPL/RPR) ~ 0.5, derived using Hoeffding's inequality"
RPL		0= "Reads Placed Left: number of reads supporting the alternate balanced to the left (5') of the alternate allele"
RPR		127= "Reads Placed Right: number of reads supporting the alternate balanced to the right (3') of the alternate allele"
EPP		3.0274= "End Placement Probability: Phred-scaled upper-bounds estimate of the probability of observing the deviation between EL and ER given E(EL/ER) ~ 0.5, derived using Hoeffding's inequality"
EPPR		3.0103= "End Placement Probability for reference observations: Phred-scaled upper-bounds estimate of the probability of observing the deviation between EL and ER given E(EL/ER) ~ 0.5, derived using Hoeffding's inequality"
DPRA		0= "Alternate allele depth ratio.  Ratio between depth in samples with each called alternate allele and those without."
ODDS		512.177= "The log odds ratio of the best genotype combination to the second-best."
GTI		0= "Number of genotyping iterations required to reach convergence or bailout."
TYPE		snp= "The type of allele, either snp, mnp, ins, del, or complex."
CIGAR		1X= "The extended CIGAR representation of each alternate allele, with the exception that '=' is replaced by 'M' to ease VCF parsing.  Note that INDEL alleles do not have the first matched base (which is provided by default, per the spec) referred to by the CIGAR."
***NUMALT		1= "Number of unique non-reference alleles in called genotypes at this position."
***MEANALT		1= "Mean number of unique non-reference allele observations per sample with the corresponding alternate alleles."
***LEN		1= "allele length"
MQM		35.7795= "Mean mapping quality of observed alternate alleles"
MQMR		35.5789= "Mean mapping quality of observed reference alleles"
PAIRED		1= "Proportion of observed alternate alleles which are supported by properly paired read fragments"
PAIREDR		1= "Proportion of observed reference alleles which are supported by properly paired read fragments"
MIN		= "Minimum depth in gVCF output block."
END		= "Last position (inclusive) in gVCF output record."




=========================
Row extracted from one of Isabel's VCF _cutoff files for:
cat HI.3518.007.Index_2.9146_cutoff | grep "PSME_00002779-RA_M31375"

This row corresponds to the first row in the MAF_cutoff.csv file:
PSME_00002779-RA_M31375	479	.	C	T	0.19723	Qual	AB=0;ABP=0;AC=2;AF=1;AN=2;AO=294;CIGAR=1X;DP=600;DPB=600;DPRA=0;EPP=7.26461;EPPR=4.53303;GTI=0;LEN=1;MEANALT=2;MQM=1.2483;MQMR=1.21992;NS=1;NUMALT=1;ODDS=3.06915;PAIRED=1;PAIREDR=0.995851;PAO=0;PQA=0;PQR=0;PRO=0;QA=10316;QR=8682;RO=241;RPL=155;RPP=4.90111;RPPR=15.3453;RPR=139;RUN=1;SAF=66;SAP=196.847;SAR=228;SRF=63;SRP=122.171;SRR=178;TYPE=snp	GT:DP:DPR:RO:QR:AO:QA:GL	1/1:600:600,294:241:8682:294:10316:-6.09436,-134.679,0


PSME_00002779-RA_M31375	
479	
.	
C	
T	
0.19723	
Qual	
AB=0;ABP=0;AC=2;AF=1;AN=2;AO=294;CIGAR=1X;DP=600;DPB=600;DPRA=0;EPP=7.26461;EPPR=4.53303;GTI=0;LEN=1;MEANALT=2;MQM=1.2483;MQMR=1.21992;NS=1;NUMALT=1;ODDS=3.06915;PAIRED=1;PAIREDR=0.995851;PAO=0;PQA=0;PQR=0;PRO=0;QA=10316;QR=8682;RO=241;RPL=155;RPP=4.90111;RPPR=15.3453;RPR=139;RUN=1;SAF=66;SAP=196.847;SAR=228;SRF=63;SRP=122.171;SRR=178;TYPE=snp	
GT:DP:DPR:RO:QR:AO:QA:GL	
1/1:600:600,294:241:8682:294:10316:-6.09436,-134.679,0



AB=0;ABP=0;AC=2;AF=1;AN=2;AO=294;
CIGAR=1X;
DP=600;DPB=600;DPRA=0;
EPP=7.26461;EPPR=4.53303;
GTI=0;
LEN=1;
MEANALT=2;MQM=1.2483;MQMR=1.21992;NS=1;
NUMALT=1;
ODDS=3.06915;
PAIRED=1;PAIREDR=0.995851;PAO=0;PQA=0;PQR=0;PRO=0;
QA=10316;QR=8682;
RO=241;RPL=155;RPP=4.90111;RPPR=15.3453;RPR=139;RUN=1;
SAF=66;SAP=196.847;SAR=228;SRF=63;SRP=122.171;SRR=178;
TYPE=snp	

===========================

In each of these, the number before the | is from Jun-Jun's data, and the number after the | is from Isabel's.

NS		1 | 1= "Number of samples with data"
***DP		165 | 600= "Total read depth at the locus"
***DPB		165 | 600= "Total read depth per bp at the locus; bases in reads overlapping / bases in haplotype"
***AC		1 | 2= "Total number of alternate alleles in called genotypes"
***AN		1 | 2= "Total number of alleles in called genotypes"
AF		1 | 1= "Estimated allele frequency in the range (0,1]"
***RO		38 | 241= "Reference allele observation count, with partial observations recorded fractionally"
***AO		127 | 294= "Alternate allele observations, with partial observations recorded fractionally"
PRO		0 | 0= "Reference allele observation count, with partial observations recorded fractionally"
PAO		0 | 0= "Alternate allele observations, with partial observations recorded fractionally"
QR		1176 | 8682= "Reference allele quality sum in phred"
QA		4263 | 10316= "Alternate allele quality sum in phred"
PQR		0 | 0= "Reference allele quality sum in phred for partial observations"
PQA		0 | 0= "Alternate allele quality sum in phred for partial observations"
SRF		19 | 63= "Number of reference observations on the forward strand"
SRR		19 | 178= "Number of reference observations on the reverse strand"
SAF		64 | 66= "Number of alternate observations on the forward strand"
SAR		63 | 228= "Number of alternate observations on the reverse strand"
SRP		3.0103 | 122.171= "Strand balance probability for the reference allele: Phred-scaled upper-bounds estimate of the probability of observing the deviation between SRF and SRR given E(SRF/SRR) ~ 0.5, derived using Hoeffding's inequality"
SAP		3.0274 | 196.847= "Strand balance probability for the alternate allele: Phred-scaled upper-bounds estimate of the probability of observing the deviation between SAF and SAR given E(SAF/SAR) ~ 0.5, derived using Hoeffding's inequality"
AB		0 | 0= "Allele balance at heterozygous sites: a number between 0 and 1 representing the ratio of reads showing the reference allele to all reads, considering only reads from individuals called as heterozygous"
ABP		0 | 0= "Allele balance probability at heterozygous sites: Phred-scaled upper-bounds estimate of the probability of observing the deviation between ABR and ABA given E(ABR/ABA) ~ 0.5, derived using Hoeffding's inequality"
RUN		1 | 1= "Run length: the number of consecutive repeats of the alternate allele in the reference genome"
RPP		278.787 | 4.90111= "Read Placement Probability: Phred-scaled upper-bounds estimate of the probability of observing the deviation between RPL and RPR given E(RPL/RPR) ~ 0.5, derived using Hoeffding's inequality"
RPPR		85.5263 | 15.3453= "Read Placement Probability for reference observations: Phred-scaled upper-bounds estimate of the probability of observing the deviation between RPL and RPR given E(RPL/RPR) ~ 0.5, derived using Hoeffding's inequality"
RPL		0 | 155= "Reads Placed Left: number of reads supporting the alternate balanced to the left (5') of the alternate allele"
RPR		127 | 139= "Reads Placed Right: number of reads supporting the alternate balanced to the right (3') of the alternate allele"
EPP		3.0274 | 7.26461= "End Placement Probability: Phred-scaled upper-bounds estimate of the probability of observing the deviation between EL and ER given E(EL/ER) ~ 0.5, derived using Hoeffding's inequality"
EPPR		3.0103 | 4.53303= "End Placement Probability for reference observations: Phred-scaled upper-bounds estimate of the probability of observing the deviation between EL and ER given E(EL/ER) ~ 0.5, derived using Hoeffding's inequality"
DPRA		0 | 0= "Alternate allele depth ratio.  Ratio between depth in samples with each called alternate allele and those without."
ODDS		512.177 | 3.06915= "The log odds ratio of the best genotype combination to the second-best."
GTI		0 | 0= "Number of genotyping iterations required to reach convergence or bailout."
TYPE		snp | snp= "The type of allele, either snp, mnp, ins, del, or complex."
CIGAR		1X | 1X= "The extended CIGAR representation of each alternate allele, with the exception that '=' is replaced by 'M' to ease VCF parsing.  Note that INDEL alleles do not have the first matched base (which is provided by default, per the spec) referred to by the CIGAR."
***NUMALT		1 | 1= "Number of unique non-reference alleles in called genotypes at this position."
***MEANALT		1 | 2= "Mean number of unique non-reference allele observations per sample with the corresponding alternate alleles."
***LEN		1 | 1= "allele length"
MQM		35.7795 | 1.2483= "Mean mapping quality of observed alternate alleles"
MQMR		35.5789 | 1.21992= "Mean mapping quality of observed reference alleles"
PAIRED		1 | 1= "Proportion of observed alternate alleles which are supported by properly paired read fragments"
PAIREDR		1 | 0.995851= "Proportion of observed reference alleles which are supported by properly paired read fragments"
MIN		 | = "Minimum depth in gVCF output block."
END		 | = "Last position (inclusive) in gVCF output record."









***DP		165 | 600= "Total read depth at the locus"
***DPB		165 | 600= "Total read depth per bp at the locus; bases in reads overlapping / bases in haplotype"
***AC		1 | 2= "Total number of alternate alleles in called genotypes"
***AN		1 | 2= "Total number of alleles in called genotypes"
AF		1 | 1= "Estimated allele frequency in the range (0,1]"
***RO		38 | 241= "Reference allele observation count, with partial observations recorded fractionally"
***AO		127 | 294= "Alternate allele observations, with partial observations recorded fractionally"
***NUMALT		1 | 1= "Number of unique non-reference alleles in called genotypes at this position."
***MEANALT		1 | 2= "Mean number of unique non-reference allele observations per sample with the corresponding alternate alleles."
***LEN		1 | 1= "allele length"

